#cloud-config
#
# #####################################################################
# ## CLOUD-CONFIG: PERFORMANCE DE NÓ (DOCKER/K8S/SWARM)
# ## Foco: Rede, Memória e CPU (Otimizações de I/O removidas)
# ## Autor: Marllus Lustosa (Baseado em testes de performance)
# #####################################################################
#

# ---
# FASE 1: Escrita de Arquivos de Configuração
# ---
write_files:
  
  # 1.1 Otimizações de Kernel (Rede, Memória, FS)
  # O coração do tuning. Aumenta buffers, habilita BBR,
  # otimiza o uso de swap e define limites de arquivos.
  - path: /etc/sysctl.d/99-docker-performance.conf
    permissions: '0644'
    content: |
      # === Tuning de Rede (BBR + Buffers) ===
      net.core.default_qdisc = fq
      net.ipv4.tcp_congestion_control = bbr
      
      # Aumenta buffers de rede para links de alta velocidade (10GbE+)
      net.core.rmem_max = 16777216
      net.core.wmem_max = 16777216
      net.core.rmem_default = 1048576
      net.core.wmem_default = 1048576
      net.ipv4.tcp_rmem = 4096 87380 16777216
      net.ipv4.tcp_wmem = 4096 65536 16777216
      
      # Aumenta filas de backlog para picos de tráfego
      net.core.netdev_max_backlog = 30000
      net.core.somaxconn = 8192
      net.ipv4.tcp_max_syn_backlog = 8192
      
      # Reuso rápido de sockets
      net.ipv4.tcp_tw_reuse = 1
      net.ipv4.tcp_fastopen = 3
      net.ipv4.tcp_slow_start_after_idle = 0
      
      # === Tuning de Memória (v5) ===
      # vm.swappiness=0: Evita swap agressivamente
      vm.swappiness = 0
      # Mantém caches de FS (dentry/inode) por mais tempo
      vm.vfs_cache_pressure = 50
      
      # === Tuning de FS e Sistema ===
      fs.inotify.max_user_watches = 524288
      fs.inotify.max_user_instances = 512
      fs.file-max = 2097152
      
      # === Requisitos de Rede do Docker/K8s ===
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.netfilter.nf_conntrack_max = 1048576

  # 1.2 Otimização do Daemon do Docker
  # Usa overlay2 e logging rotativo para evitar sobrecarga de disco
  - path: /etc/docker/daemon.json
    permissions: '0644'
    content: |
      {
        "storage-driver": "overlay2",
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "live-restore": true
      }

  # 1.3 Limites de Sistema (ulimits)
  # Aumenta limites de arquivos abertos (nofile) e processos (nproc)
  - path: /etc/security/limits.d/99-docker-limits.conf
    permissions: '0644'
    content: |
      * soft nofile 1048576
      * hard nofile 1048576
      * soft nproc 1048576
      * hard nproc 1048576

  # 1.4 Módulos do Kernel
  # Garante que módulos essenciais sejam carregados no boot
  - path: /etc/modules-load.d/docker-performance.conf
    permissions: '0644'
    content: |
      br_netfilter
      overlay
      tcp_bbr
      nf_conntrack

  # 1.5 Desabilitar Transparent Huge Pages (THP)
  # THP pode causar picos de latência em workloads de DB/containers
  - path: /etc/rc.local
    permissions: '0755'
    content: |
      #!/bin/bash
      # Desabilita Transparent Huge Pages (THP)
      echo never > /sys/kernel/mm/transparent_hugepage/enabled
      echo never > /sys/kernel/mm/transparent_hugepage/defrag
      exit 0

# ---
# FASE 2: Atualizações e Pacotes
# ---
package_update: true
package_upgrade: true
packages:
  # Pacotes de Monitoramento e Performance
  - htop
  - iotop
  - pcp  # Substituto moderno do dstat
  - atop
  - iperf3
  - ethtool
  - linux-cpupower
  - bpfcc-tools
  - bpftrace
  - linux-headers-amd64
  # Pré-requisitos para instalação do Docker
  - curl
  - gnupg
  - ca-certificates
  # Pacotes utilitários
  - iptables
  - psmisc
  - screen

# Configurar APT
apt:
  preserve_sources_list: false
  sources_list: |
    deb http://deb.debian.org/debian trixie main
    deb http://security.debian.org/debian-security trixie-security main
    deb http://deb.debian.org/debian trixie-updates main

# ---
# FASE 3: Comandos de Configuração
# ---
runcmd:
  # 3.1 Aplicar Módulos e Sysctl
  - modprobe overlay
  - modprobe br_netfilter
  - modprobe tcp_bbr
  - sysctl --system
  
  # 3.2 Otimização de C-State (Latência de CPU) no GRUB
  # Reduz latência de "despertar" da CPU em ambientes virtualizados
  - sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="intel_idle.max_cstate=1 processor.max_cstate=1 /' /etc/default/grub
  - update-grub
  
  # 3.3 Desabilitar serviços desnecessários
  - systemctl disable --now bluetooth.service cups.service ModemManager.service avahi-daemon.service smartd.service irqbalance.service
  
  # 3.4 Habilitar rc.local (para desabilitar THP)
  - systemctl enable rc-local.service
  - systemctl start rc-local.service

  # 3.5 Instalação do Docker (Método Oficial)
  - |
      echo "=== Instalando Docker Engine (Método Oficial) ==="
      apt-get update
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
      chmod a+r /etc/apt/keyrings/docker.asc
      
      echo "Types: deb" > /etc/apt/sources.list.d/docker.sources
      echo "URIs: https://download.docker.com/linux/debian" >> /etc/apt/sources.list.d/docker.sources
      echo "Suites: $(. /etc/os-release && echo "$VERSION_CODENAME")" >> /etc/apt/sources.list.d/docker.sources
      echo "Components: stable" >> /etc/apt/sources.list.d/docker.sources
      echo "Signed-By: /etc/apt/keyrings/docker.asc" >> /etc/apt/sources.list.d/docker.sources
      
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - systemctl enable --now docker

# ---
# FASE 4: Finalização
# ---
final_message: "CloudInit concluído em $UPTIME segundos. Nó de performance pronto."
power_state:
  mode: reboot
  message: "Reiniciando para aplicar configurações de kernel (GRUB)"
  timeout: 15
  condition: true
